import requests
import threading
import smtplib
from email.mime.text import MIMEText
from email.header import Header
import json
with open('./config.json', 'r') as ipt:
    config = json.load(ipt)
sender = config['sender']#'875136184@qq.com'
receivers = config['receivers']#['875136184@qq.com']
message = MIMEText('Python 邮件发送测试...', 'plain', 'utf-8')
message['From'] = Header("菜鸟教程", 'utf-8')     # 发送者
message['To'] =  Header("测试", 'utf-8')          # 接收者
 
subject = 'Python SMTP 邮件测试'
message['Subject'] = Header(subject, 'utf-8')
def sendEmail():
    smtpObj = smtplib.SMTP_SSL("smtp.qq.com", 465)    # 25 为 SMTP 端口号
    smtpObj.login(config['sender'],config['passwd'])
    smtpObj.sendmail(sender, receivers, message.as_string())
    print ("邮件发送成功")
url="http://wx.pt.tsinghua.edu.cn/a/reservation/reservationTreatment/calcSignalSourceInfo"
data = "curSource=119&treeCode=4&doctorId=1357619620714504192&dateStr=2021-12-21&deptHisId=1361&doctorHisId=1422&doctorHisName=%E5%BC%A0%E5%AE%9D%E7%BA%A2&seatType=gr&flag=0"
def query():
    res = requests.post(url=url, data=data)
    if res.json()['num']>0:
        print("send email")
        sendEmail()
    else:
        print(res.json()['num'])
        timer = threading.Timer(600, query)
        timer.start()
global timer
timer = threading.Timer(1, query)
timer.start()
# sendEmail()
